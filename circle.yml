machine:
  services:
    - docker

dependencies:
  override:
    - docker info
    - docker build --rm=false --tag=dash/testing ./dash/scripts/docker-testing/

test:
  override:
    - docker run -v $PWD:/opt/dash dash/testing /bin/sh -c "export DASH_MAX_UNITS='4'; export GTEST_TOTAL_SHARDS=${CIRCLE_NODE_TOTAL}; export GTEST_SHARD_INDEX=${CIRCLE_NODE_INDEX}; sh dash/scripts/dash-ci.sh | grep -v 'LOG =' | tee dash-ci.log 2> dash-ci.err;":
        parallel:true
    - ! cat ./dash-ci.log | grep "FAILED"
    - cat ./dash-ci.log | grep "PASSED" || exit 1
  post:
    - cat ./build-ci/*/*/test_mpi.log | grep -v "LOG"
    - cat ./dash-ci.err
    - cat ./build-ci/*/*/build.log
